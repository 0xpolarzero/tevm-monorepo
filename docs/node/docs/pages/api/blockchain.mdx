# Blockchain Package

The `@tevm/blockchain` package provides a custom implementation of the Ethereum blockchain, offering functionality for managing blocks, handling chain state, and interacting with the blockchain.

## Main Exports

### Chain Interface

The main interface for interacting with the blockchain.

```typescript
type Chain = {
  // Core Methods
  putBlock(block: Block): Promise<void>
  getBlock(blockId: Uint8Array | number | bigint): Promise<Block>
  delBlock(blockHash: Uint8Array): Promise<void>
  getBlockByTag(blockTag: Hex | Uint8Array | number | bigint | BlockTag): Promise<Block>

  // Iterator Methods
  getIteratorHead(name?: string): Promise<Block>
  setIteratorHead(tag: string, headHash: Uint8Array): Promise<void>
  iterator(name: string, onBlock: OnBlock, maxBlocks?: number, releaseLockOnCallback?: boolean): Promise<number>

  // Chain State
  getCanonicalHeadBlock(): Promise<Block>
  validateHeader(header: BlockHeader, height?: bigint): Promise<void>
  getTotalDifficulty?(hash: Uint8Array, number?: bigint): Promise<bigint>

  // Utilities
  shallowCopy(): Chain
  deepCopy(): Promise<Chain>

  // Optional Events
  events?: AsyncEventEmitter<BlockchainEvents>
}
```

### Creating a Chain

The main factory function to create a new blockchain instance:

```typescript
async function createChain(options: ChainOptions): Promise<Chain>
```

#### ChainOptions

```typescript
type ChainOptions = {
  // Logging configuration
  loggingLevel?: LogOptions['level']

  // Chain configuration
  common: Common
  genesisBlock?: Block
  genesisStateRoot?: Uint8Array

  // Forking configuration
  fork?: {
    transport: { request: EIP1193RequestFn }
    blockTag?: BlockTag | bigint | `0x${string}`
  }
}
```

## Core Functionality

### Block Management

#### Adding Blocks

```typescript
await chain.putBlock(block)
```

Adds a new block to the blockchain. The block must match the chain's chainId.

#### Retrieving Blocks

```typescript
// By hash or number
const block = await chain.getBlock(blockId)

// By tag (latest, earliest, pending, etc.)
const block = await chain.getBlockByTag(blockTag)

// Get latest block
const head = await chain.getCanonicalHeadBlock()
```

#### Deleting Blocks

```typescript
await chain.delBlock(blockHash)
```

Deletes a block and all its child blocks from the chain.

### Chain State

#### Header Validation

```typescript
await chain.validateHeader(header, height?)
```

Validates a block header against the chain's rules.

#### Iterator Management

```typescript
// Set iterator head
await chain.setIteratorHead(tag, headHash)

// Get iterator head
const head = await chain.getIteratorHead(tag)

// Iterate through blocks
await chain.iterator(name, (block, reorg) => {
  // Process block
}, maxBlocks)
```

### Chain Copying

```typescript
// Shallow copy (shares state)
const shallowCopy = chain.shallowCopy()

// Deep copy (independent state)
const deepCopy = await chain.deepCopy()
```

## Events

The blockchain can optionally emit events for various operations:

```typescript
chain.events?.on('block', (block) => {
  // Handle new block
})
```

## Error Handling

The blockchain package throws specific errors for various conditions:

- `UnknownBlockError`: When a requested block cannot be found
- `InvalidBlockError`: When a block fails validation
- `InternalError`: For internal blockchain errors

## Usage Example

```typescript
import { createChain } from '@tevm/blockchain'
import { Common } from '@tevm/common'

// Create a new chain
const chain = await createChain({
  common: new Common({ chain: 'mainnet' }),
  loggingLevel: 'info'
})

// Add a block
await chain.putBlock(block)

// Get latest block
const latestBlock = await chain.getCanonicalHeadBlock()

// Fork from existing chain
const forkedChain = await createChain({
  common: new Common({ chain: 'mainnet' }),
  fork: {
    transport: { request: myJsonRpcProvider },
    blockTag: 'latest'
  }
})
```